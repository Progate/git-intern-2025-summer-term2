# E2E (End-to-End) Tests

このディレクトリには、mygitコマンドのE2Eテストが含まれています。

## 目的

E2Eテストは、実際のユーザーの使い方と同じようにコマンドを実行し、システム全体の動作を確認します。

- 実際のファイルシステムを使用
- .gitディレクトリの読み書き
- コマンドライン引数の処理
- 標準出力/標準エラー出力の確認

## テストケース一覧

### mygit log コマンド

各テストケースは、一時ディレクトリ（tmpディレクトリ）に作成されたGitリポジトリに対して特定のGit操作を実行した状態で`mygit log`を実行し、その挙動をテストしています。

1. **正常系**

   - **複数のコミット履歴を表示**
     - Git操作: `git init` → ファイル作成・`git add .` → `git commit -m 'first commit'` → ファイル作成・`git add .` → `git commit -m 'add feature'` → ファイル作成・`git add .` → `git commit -m 'fix bug'`
     - テスト内容: 3つのコミット履歴が最新から順番に表示されることを確認
   - **単一のコミット履歴を表示**
     - Git操作: `git init` → ファイル作成・`git add .` → `git commit -m 'initial commit'`
     - テスト内容: 1つだけのコミットが正しく表示されることを確認
   - **長いコミットメッセージを正しく表示**
     - Git操作: `git init` → ファイル作成・`git add .` → `git commit -m '複数行にわたる長いコミットメッセージ'`
     - テスト内容: 複数行・複数段落のコミットメッセージが正しく表示されることを確認
   - **特殊文字を含むコミットメッセージを正しく表示**
     - Git操作: `git init` → ファイル作成・`git add .` → `git commit -m '日本語や記号(!@#$%^&*())を含むメッセージ'`
     - テスト内容: 日本語や特殊文字が含まれるコミットメッセージが正しく表示されることを確認

2. **エラー系**

   - **.gitディレクトリが存在しない場合**
     - Git操作: なし（空のディレクトリのまま）
     - テスト内容: Gitリポジトリではない場所で`mygit log`を実行した際のエラーハンドリングを確認
   - **空のリポジトリの場合（コミットが存在しない）**
     - Git操作: `git init`のみ（コミットなし）
     - テスト内容: コミットが1つも存在しないリポジトリでのエラーハンドリングを確認
   - **HEADファイルが存在しない場合**
     - Git操作: `git init` → コミット作成後、`.git/HEAD`ファイルを手動削除
     - テスト内容: リポジトリが破損した状態でのエラーハンドリングを確認

3. **境界値**

   - **マージコミット（複数の親を持つコミット）**
     - Git操作: `git init` → 初期コミット → `git checkout -b feature` → featureブランチでコミット → `git checkout master` → `git merge feature --no-ff`
     - テスト内容: マージコミットを含む履歴が正しく表示されることを確認
   - **作者名に特殊文字が含まれる場合**
     - Git操作: `git init` → `git config user.name '田中 太郎'` → `git config user.email 'tanaka@例え.jp'` → コミット作成
     - テスト内容: 日本語の作者名やメールアドレスが正しく表示されることを確認
   - **コミットメッセージに改行が含まれる場合**
     - Git操作: `git init` → ファイル作成・`git add .` → `git commit -m 'multiline message\n\nSecond line\nThird line'`
     - テスト内容: 改行を含むコミットメッセージが正しく表示されることを確認

## 実行方法

### 前提条件

- Node.js とnpmがインストールされていること
- プロジェクトの依存関係がインストールされていること（`npm install`）
- TypeScriptがビルドされていること（`npm run build`）

### 個別テスト実行

```bash
# 特定のテストファイルを実行
npx jest tests/e2e/log.e2e.test.ts

# 特定のテストケースを実行
npx jest tests/e2e/log.e2e.test.ts -t "複数のコミット履歴を表示"
```

### 全E2Eテスト実行

```bash
# e2eディレクトリ内の全テストを実行
npx jest tests/e2e/

# カバレッジレポートも生成
npx jest tests/e2e/ --coverage
```

### 詳細ログ付き実行

```bash
# デバッグ情報を含めて実行
npx jest tests/e2e/ --verbose
```

## テスト環境

- 各テストは独立した一時ディレクトリで実行されます
- テスト用のGitリポジトリが自動的に作成・削除されます
- 実際のgitコマンドを使用してテストデータを準備します

## 注意事項

- E2Eテストは実際のファイルシステムを使用するため、実行時間がかかる場合があります
- テスト実行中は一時ファイルが作成されますが、テスト終了後に自動削除されます
- 並列実行時に競合状態が発生しないよう、各テストは独立したディレクトリを使用します

## 現状のテスト対応状況（2025/08/28時点）

### 対応できているケース

- 単一のコミット履歴を表示（正常系）
- 特殊文字を含むコミットメッセージの表示（正常系）
- HEADファイルが存在しない場合（エラー系）
- 作者名に特殊文字が含まれる場合（境界値）

### 対応できていない/失敗するケース

- マージコミット（複数の親を持つコミット）
  - テスト失敗。mainブランチが存在しないため checkout main でエラー。
  - テスト失敗。gitの仕様で空メッセージのコミットは作成できない。

### 実装上の問題（2025/08/28時点）

#### 1. 長いコミットメッセージを正しく表示（正常系）

- テストで`process.chdir(testDir)`のアサーションが失敗。
- テストディレクトリ切り替えやファイル操作のタイミングが不安定。`setupGitRepo`の呼び出しやテストディレクトリの管理に問題がある可能性。
- 実装上の課題: テストディレクトリの切り替えが正しく反映されていない、またはテストの状態管理が不十分。

#### 2. 特殊文字を含むコミットメッセージを正しく表示（正常系）

- `Object.entries(commit.files)`のアサーションが失敗。
- テストデータの生成やファイル操作が正しく行われていない可能性。コミットメッセージやファイル内容の特殊文字処理に問題がある場合も。
- 実装上の課題: テスト用ファイルの作成・コミット処理のロジックが不安定。特殊文字のエンコーディングやファイル書き込み処理の見直しが必要。

#### 3. マージコミット（複数の親を持つコミット）（境界値）

- `fs.writeFileSync("README.md", "# Hello World")`のアサーションが失敗。
- マージコミットの履歴取得・表示ロジックがGitの仕様と異なる。親コミットの辿り方や履歴の順序、表示内容が不十分。
- 実装上の課題: `LogService`の`collectCommitHistory`が幅優先探索で履歴を収集しているが、マージコミットの表示順や親の扱いがGit本家と異なるため、期待通りの出力にならない。

#### 4. コミットメッセージに改行が含まれる場合（境界値）

- `assert(fixBugIndex !== -1 && fixBugIndex < addFeatureIndex)`のアサーションが失敗。
- コミットメッセージの改行処理や履歴の表示順が不正確。複数行メッセージのパースや表示ロジックに問題がある。
- 実装上の課題: `LogService`の`formatCommit`でメッセージの改行・インデント処理が不十分な可能性。履歴の順序やコミット間の区切りも要検討。

---

#### 共通の実装課題

- テスト用一時ディレクトリの切り替え・管理が不安定
- コミット履歴の収集・表示ロジックがGit本家と異なる部分がある
- 特殊文字や改行など境界値の処理が不十分
- テストデータ生成やファイル操作のタイミング・状態管理に注意が必要
- すべてのケースに完全対応しているわけではありません。
- gitコマンドの仕様や初期ブランチ名（master/main）による影響があります。
- 境界値やエラー系は今後の実装・仕様変更で対応可能です。

### 実装上の問題（マージコミット関連）

- マージコミット（複数の親を持つコミット）テストは、ブランチ名の修正でセットアップは成功するが、
  mygit logコマンドの出力が期待通りにならず、アサーションで失敗する。
- これは、実装側でマージコミット（親が複数あるコミット）の履歴取得・表示ロジックが十分でない可能性がある。
- 具体的には、親コミットの辿り方や履歴の順序、表示内容がGitの仕様と異なる場合がある。
- 今回はこの部分の実装改修は行わないため、テスト・実装の変更は不要。
